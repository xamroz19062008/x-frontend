<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Корзина — TIMEPIECE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="/css/style.css" />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />

    <script>
      const API_BASE = "https://x-54uc.onrender.com";
      const FRONTEND_BASE = "https://x-frontend-xi.vercel.app";

      function resolveImageUrl(url) {
        if (!url) return "";
        if (url.startsWith("http://") || url.startsWith("https://")) return url;
        if (url.startsWith("/")) return API_BASE + url;
        return API_BASE + "/" + url;
      }

      // Добавил: выставляем правильные ссылки авторизации
      function initAuthLinks() {
        const loginLink = document.getElementById("link-login");
        const signupLink = document.getElementById("link-signup");
        const accountLink = document.getElementById("link-account");
        const logoutLink = document.getElementById("link-logout");

        const returnUrl = `${FRONTEND_BASE}${window.location.pathname}?logged=1`;
        const loginUrl = `${API_BASE}/accounts/login/?next=${encodeURIComponent(
          returnUrl
        )}`;

        if (loginLink) loginLink.href = loginUrl;
        if (signupLink) signupLink.href = `${API_BASE}/signup/`;
        if (accountLink) accountLink.href = `${API_BASE}/account/`;
        if (logoutLink) logoutLink.href = `${API_BASE}/accounts/logout/`;
      }
    </script>
  </head>

  <body>
    <header class="header glass-panel">
      <div class="container header-inner">
        <a href="/index.html" class="logo">TIMEPIECE</a>

        <nav class="nav">
          <a href="/catalog.html">Каталог</a>
          <a href="/cart.html">Корзина</a>
        </nav>

        <div class="auth-links" id="auth-links">
          <a id="link-login" href="#">Войти</a>
          <a id="link-signup" href="#">Регистрация</a>

          <a id="link-account" href="#" style="display: none">Аккаунт</a>
          <a id="link-logout" href="#" style="display: none">Выйти</a>
        </div>
      </div>
    </header>

    <main class="section">
      <div class="container">
        <div
          class="glass-panel"
          style="padding: 32px; max-width: 960px; margin: 0 auto"
        >
          <h1 class="section-title" style="margin-bottom: 24px">Корзина</h1>

          <div id="cart-empty" style="display: none">
            <p>Ваша корзина пуста.</p>
          </div>

          <div id="cart-content" style="display: none">
            <table class="cart-table">
              <thead>
                <tr>
                  <th>Модель</th>
                  <th>Цена</th>
                  <th>Количество</th>
                  <th>Итого</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="cart-body"></tbody>
            </table>

            <div class="cart-total mono" style="margin-top: 16px">
              Сумма заказа: <span id="cart-total">0</span> сум
            </div>

            <div class="checkout-block" style="margin-top: 40px">
              <h2 class="section-title" style="font-size: 24px">Оформление</h2>

              <div class="form-row" style="margin-bottom: 16px">
                <label>Адрес:</label>
                <input
                  id="location"
                  type="text"
                  placeholder="Введите адрес"
                  required
                />
              </div>

              <div class="form-row" style="margin-bottom: 16px">
                <label>Телефон:</label>
                <input id="phone" type="text" placeholder="+998..." required />
              </div>

              <p class="mono">Выберите точку на карте:</p>
              <div
                id="map"
                style="
                  width: 100%;
                  height: 320px;
                  border-radius: 16px;
                  margin-bottom: 16px;
                "
              ></div>

              <button id="checkout-btn" class="btn btn-primary" disabled>
                ПЕРЕЙТИ К ОПЛАТЕ
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
      function getCart() {
        return JSON.parse(localStorage.getItem("timepiece_cart") || "[]");
      }

      function setCart(cart) {
        localStorage.setItem("timepiece_cart", JSON.stringify(cart));
        renderCart();
      }

      function renderCart() {
        const cart = getCart();
        const body = document.getElementById("cart-body");
        const empty = document.getElementById("cart-empty");
        const content = document.getElementById("cart-content");
        const totalEl = document.getElementById("cart-total");

        body.innerHTML = "";

        if (cart.length === 0) {
          empty.style.display = "block";
          content.style.display = "none";
          return;
        }

        empty.style.display = "none";
        content.style.display = "block";

        let total = 0;

        cart.forEach((item, index) => {
          const sum = (item.price || 0) * (item.quantity || 0);
          total += sum;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>
              <div style="display:flex;gap:12px;align-items:center">
                <img
                  src="${resolveImageUrl(item.image_url)}"
                  style="width:52px;height:52px;border-radius:12px;object-fit:cover"
                  alt=""
                >
                <div>${item.name || ""}</div>
              </div>
            </td>
            <td>${item.price || 0} сум</td>
            <td>
              <button onclick="changeQty(${index}, -1)">−</button>
              ${item.quantity || 0}
              <button onclick="changeQty(${index}, 1)">+</button>
            </td>
            <td>${sum} сум</td>
            <td><a href="#" onclick="removeItem(${index})">Удалить</a></td>
          `;
          body.appendChild(tr);
        });

        totalEl.textContent = total;
      }

      function changeQty(i, delta) {
        const cart = getCart();
        cart[i].quantity += delta;
        if (cart[i].quantity <= 0) cart.splice(i, 1);
        setCart(cart);
      }

      function removeItem(i) {
        const cart = getCart();
        cart.splice(i, 1);
        setCart(cart);
      }

      let lat = null;
      let lng = null;

      const map = L.map("map").setView([41.3111, 69.2797], 12);
      let marker = null;

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(
        map
      );

      map.on("click", function (e) {
        lat = e.latlng.lat;
        lng = e.latlng.lng;

        if (!marker) marker = L.marker([lat, lng]).addTo(map);
        else marker.setLatLng([lat, lng]);

        validateCheckout();
      });

      const locationInput = document.getElementById("location");
      const phoneInput = document.getElementById("phone");
      const btn = document.getElementById("checkout-btn");

      function validateCheckout() {
        btn.disabled = !(
          locationInput.value.trim() &&
          phoneInput.value.trim() &&
          lat &&
          lng
        );
      }

      locationInput.addEventListener("input", validateCheckout);
      phoneInput.addEventListener("input", validateCheckout);

      btn.addEventListener("click", async () => {
        const cart = getCart();

        // ВАЖНО: исправил endpoint на правильный (как у тебя в Django urls)
        const res = await fetch(`${API_BASE}/api/orders/create/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            location: locationInput.value,
            phone: phoneInput.value,
            latitude: lat,
            longitude: lng,
            items: cart,
          }),
        });

        if (res.ok) {
          localStorage.removeItem("timepiece_cart");
          alert("Заказ успешно отправлен!");
          window.location.href = "/index.html";
        } else {
          const text = await res.text().catch(() => "");
          console.error("Order error:", res.status, text);
          alert("Ошибка оформления заказа");
        }
      });

      renderCart();
    </script>

    <script>
      function renderAuthLinks() {
        const isLogged = localStorage.getItem("tp_logged_in") === "1";

        document.getElementById("link-login").style.display = isLogged
          ? "none"
          : "inline";
        document.getElementById("link-signup").style.display = isLogged
          ? "none"
          : "inline";
        document.getElementById("link-account").style.display = isLogged
          ? "inline"
          : "none";
        document.getElementById("link-logout").style.display = isLogged
          ? "inline"
          : "none";
      }

      const params = new URLSearchParams(window.location.search);
      if (params.get("logged") === "1") {
        localStorage.setItem("tp_logged_in", "1");
        window.history.replaceState({}, "", window.location.pathname);
      }

      const logoutLink = document.getElementById("link-logout");
      if (logoutLink) {
        logoutLink.addEventListener("click", () => {
          localStorage.removeItem("tp_logged_in");
        });
      }

      // добавил: сначала ставим правильные ссылки, потом рендерим кнопки
      initAuthLinks();
      renderAuthLinks();
    </script>
  </body>
</html>
