<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>TIMEPIECE — полный каталог часов в Ташкенте</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="/css/style.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Manrope:wght@300;400;500;600&family=JetBrains+Mono:wght@400&display=swap"
      rel="stylesheet"
    />

    <script>
      const API_BASE = "https://x-54uc.onrender.com";
      const FRONTEND_BASE = "https://x-frontend-xi.vercel.app";

      function resolveImageUrl(url) {
        if (!url) return "";
        if (url.startsWith("http://") || url.startsWith("https://")) return url;
        if (url.startsWith("/")) return API_BASE + url;
        return API_BASE + "/" + url;
      }

      // Ставим правильные ссылки авторизации:
      // - login: редиректит назад на эту страницу с ?logged=1
      // - signup: /signup/
      // - account: /account/
      // - logout: /accounts/logout/ (после logout можно руками вернуться на фронт)
      function initAuthLinks() {
        const loginLink = document.getElementById("link-login");
        const signupLink = document.getElementById("link-signup");
        const accountLink = document.getElementById("link-account");
        const logoutLink = document.getElementById("link-logout");

        const returnUrl = `${FRONTEND_BASE}${window.location.pathname}?logged=1`;
        const loginUrl = `${API_BASE}/accounts/login/?next=${encodeURIComponent(
          returnUrl
        )}`;

        if (loginLink) loginLink.href = loginUrl;
        if (signupLink) signupLink.href = `${API_BASE}/signup/`;
        if (accountLink) accountLink.href = `${API_BASE}/account/`;
        if (logoutLink) logoutLink.href = `${API_BASE}/accounts/logout/`;
      }
    </script>
  </head>

  <body>
    <header class="header glass-panel">
      <div class="container header-inner">
        <a href="/index.html" class="logo">TIMEPIECE</a>

        <nav class="nav">
          <a href="/index.html#collection">Коллекция</a>
          <a href="/index.html#about">О нас</a>
          <a href="/index.html#service">Сервис</a>
          <a href="/index.html#contacts">Контакты</a>
          <a href="/cart.html">Корзина</a>
        </nav>

        <div class="auth-links" id="auth-links">
          <a id="link-login" href="#">Войти</a>
          <a id="link-signup" href="#">Регистрация</a>

          <a id="link-account" href="#" style="display: none">Аккаунт</a>
          <a id="link-logout" href="#" style="display: none">Выйти</a>
        </div>
      </div>
    </header>

    <main>
      <section class="section collection">
        <div class="container">
          <div class="section-header">
            <div>
              <h2 class="section-title">Полный каталог</h2>
              <p class="section-subtitle">
                Все модели, которые сейчас доступны для заказа в Ташкенте. Если
                не нашёл подходящие часы — напиши в Telegram @xamroz, можно
                сделать подбор под заказ по фото.
              </p>
            </div>
          </div>

          <div class="collection-grid" id="catalog-grid"></div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <div class="container footer-inner">
        <div class="footer-left">
          <div class="logo footer-logo">TIMEPIECE</div>
          <p class="footer-text">
            Актуальные модели из последних поставок. Для индивидуального подбора
            — Telegram @xamroz · +998 94 662 83 08
          </p>
        </div>
      </div>
      <div class="footer-bottom mono">
        © TIMEPIECE, 2025 · Все права защищены.
      </div>
    </footer>

    <!-- ===== ТВОИ ФУНКЦИИ КОРЗИНЫ — НЕ ТРОГАЛ ===== -->
    <script>
      function getCart() {
        try {
          return JSON.parse(localStorage.getItem("timepiece_cart") || "[]");
        } catch {
          return [];
        }
      }

      function setCart(cart) {
        localStorage.setItem("timepiece_cart", JSON.stringify(cart));
      }

      function addToCart(item) {
        const cart = getCart();
        const existing = cart.find((x) => x.id === item.id);

        if (existing) {
          existing.quantity += 1;
        } else {
          cart.push({
            id: item.id,
            name: item.name,
            price: item.price || 0,
            currency: item.currency || "",
            image_url: item.image_url || "",
            quantity: 1,
          });
        }

        setCart(cart);
        alert("Добавлено в корзину");
      }

      async function loadWatches() {
        try {
          const response = await fetch(`${API_BASE}/api/watches/all/`);
          if (!response.ok) throw new Error("API error");

          const data = await response.json();
          const grid = document.getElementById("catalog-grid");
          grid.innerHTML = "";

          if (!data.items || data.items.length === 0) {
            grid.innerHTML = "<p style='opacity:.8'>Товары не найдены</p>";
            return;
          }

          data.items.forEach((item) => {
            const price = new Intl.NumberFormat("ru-RU").format(
              item.price || 0
            );

            const card = document.createElement("article");
            card.className = "product-card glass-panel";

            card.innerHTML = `
              <div class="product-image">
                <img src="${resolveImageUrl(
                  item.image_url
                )}" class="product-photo" alt="">
                <span class="mono product-tag">${item.tag || ""}</span>
              </div>

              <div class="product-body">
                <h3 class="product-name">${item.name || ""}</h3>
                <p class="product-desc">${item.description || ""}</p>
                <div class="product-meta">
                  <span class="price">${item.currency || ""} ${price}</span>
                  <span class="badge">${item.badge || ""}</span>
                </div>
                <div class="product-actions">
                  <button class="btn btn-primary btn-small buy-btn" type="button">
                    Купить
                  </button>
                </div>
              </div>
            `;

            card
              .querySelector(".buy-btn")
              .addEventListener("click", () => addToCart(item));
            grid.appendChild(card);
          });
        } catch (e) {
          console.error(e);
          alert("Ошибка загрузки каталога");
        }
      }

      document.addEventListener("DOMContentLoaded", loadWatches);
    </script>

    <!-- ===== ТВОЯ ЛОГИКА AUTH UI — НЕ УДАЛЯЛ, ТОЛЬКО ДОБАВИЛ initAuthLinks() ===== -->
    <script>
      function renderAuthLinks() {
        const isLogged = localStorage.getItem("tp_logged_in") === "1";

        document.getElementById("link-login").style.display = isLogged
          ? "none"
          : "inline";
        document.getElementById("link-signup").style.display = isLogged
          ? "none"
          : "inline";
        document.getElementById("link-account").style.display = isLogged
          ? "inline"
          : "none";
        document.getElementById("link-logout").style.display = isLogged
          ? "inline"
          : "none";
      }

      // если вернулись с бекенда после логина
      const params = new URLSearchParams(window.location.search);
      if (params.get("logged") === "1") {
        localStorage.setItem("tp_logged_in", "1");
        window.history.replaceState({}, "", window.location.pathname);
      }

      const logoutLink = document.getElementById("link-logout");
      if (logoutLink) {
        logoutLink.addEventListener("click", () => {
          localStorage.removeItem("tp_logged_in");
        });
      }

      // ВАЖНО: сначала выставляем правильные href, потом рендерим кнопки
      initAuthLinks();
      renderAuthLinks();
    </script>
  </body>
</html>
